<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>로드투에어 AI 챗봇</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>
    <style>
        /* --- New Color Palette --- */
        :root {
            --main-teal: #01AAB5;
            --sub-light-yellow: #F5B800;
            --sub-deep-blue: #013780;
            --sub-action-blue: #006EEA;
            --sub-light-blue: #66ccff;
            --neutral-light-gray: #ECEDEF;
            --neutral-bg-gray: #f0f2f5;
            --neutral-white: #FFFFFF;
            --text-dark: #2c3e50;
            --error-red: #e74c3c;
            --success-green: #27ae60;
        }

        /* --- Base & Background --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', sans-serif;
            background-color: var(--neutral-bg-gray);
            background-image:
                linear-gradient(rgba(1, 170, 181, 0.07) 1px, transparent 1px),
                linear-gradient(90deg, rgba(1, 170, 181, 0.07) 1px, transparent 1px);
            background-size: 25px 25px;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- New Page Wrapper --- */
        .page-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        /* --- Language Selector (Moved) --- */
        .language-selector {
            display: flex;
            gap: 12px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .lang-icon {
            width: 40px;
            height: 40px;
            background: var(--neutral-white);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s ease-out;
            border: 2px solid transparent;
        }

        .lang-icon:hover {
            transform: scale(1.1);
        }

        .lang-icon.active {
            border-color: var(--main-teal);
        }

        /* --- Main Container --- */
        .container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            background: var(--neutral-white);
            border-radius: 24px;
            padding: 30px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            position: relative;
            z-index: 1;
            animation: fadeInFromBottom 0.8s ease-out forwards;
            overflow: hidden;
        }
        
        .container::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--main-teal), var(--sub-action-blue), var(--sub-light-blue));
        }

        @keyframes fadeInFromBottom {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Header --- */
        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            color: var(--sub-deep-blue);
            margin-bottom: 10px;
            font-weight: 800;
            line-height: 1.3;
            text-align: center;
            word-break: keep-all;
        }
        @media (max-width: 480px) {
        .header h1 {
            font-size: 1.4em;        /* 기존 1.8em → 더 작게 */
            line-height: 1.3;        /* 살짝 넉넉하게 */
            word-break: keep-all;
        }
            
        
        .header .subtitle {
            font-size: 0.95em;       /* 기존 1.1em → 더 작게 */
            font-weight: 500;
            color: #7f8c8d;
        }}

        /* --- Service Tabs --- */
        .service-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .service-tab {
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 700;
            border-radius: 50px;
            border: 2px solid var(--neutral-light-gray);
            background: var(--neutral-light-gray);
            color: var(--text-dark);
        }

        .service-tab:hover {
            transform: translateY(-2px);
            border-color: var(--main-teal);
        }

        .service-tab.active {
            background: var(--main-teal);
            color: var(--neutral-white);
            border-color: var(--main-teal);
        }
        
        /* --- Status Indicator --- */
        .status-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 25px;
            padding: 12px 15px;
            background: #e6f6f5;
            border-radius: 15px;
            color: #016a6e;
            font-size: 14px;
            font-weight: 700;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background: var(--main-teal);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(1, 170, 181, 0.7); }
            50% { box-shadow: 0 0 0 5px rgba(1, 170, 181, 0); }
        }

        /* --- Quick Questions --- */
        .quick-questions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .quick-question {
            padding: 18px 20px;
            background: var(--neutral-white);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 15px;
            font-weight: 700;
            color: var(--text-dark);
            border: 1px solid var(--neutral-light-gray);
            text-align: left;
            position: relative;
            overflow: hidden;
            border-left: 5px solid;
        }
        
        .quick-question.parking { border-color: var(--sub-action-blue); }
        .quick-question.facility { border-color: var(--main-teal); }
        .quick-question.flight { border-color: var(--sub-light-blue); }
        .quick-question.mixed { border-color: var(--sub-light-yellow); }

        .quick-question:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
        }
        
        .quick-question span { margin-right: 10px; }

        /* --- Chat Area --- */
        .chat-container {
            height: 400px;
            overflow-y: auto;
            overflow-x: hidden;
            border-radius: 20px;
            padding: 10px 20px;
            margin-bottom: 20px;
            background: var(--neutral-light-gray);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chat-container::-webkit-scrollbar { width: 8px; }
        .chat-container::-webkit-scrollbar-track { background: transparent; }
        .chat-container::-webkit-scrollbar-thumb { background: #d0d3d6; border-radius: 10px; }
        
        .message {
            padding: 12px 18px;
            border-radius: 18px;
            max-width: 80%;
            animation: fadeIn 0.5s ease-out;
            line-height: 1.6;
            word-break: break-word;
            white-space: pre-wrap;
            box-sizing: border-box; 
        }
        
        .user-message {
            background: linear-gradient(135deg, var(--sub-action-blue), var(--sub-light-blue));
            color: var(--neutral-white);
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }
        
        .bot-message-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            align-self: flex-start;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        .bot-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--main-teal);
            color: var(--neutral-white);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
            font-size: 18px;
        }

        .bot-message {
            background: var(--neutral-white);
            color: var(--text-dark);
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            flex: 1;
            min-width: 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            max-width: 100%;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .typing-indicator span {
            width: 8px; height: 8px;
            background-color: #9E9E9E;
            border-radius: 50%;
            animation: typing 1.4s infinite both;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        
        /* --- Input Area --- */
        .input-container { 
            display: flex; 
            gap: 10px;
            flex-wrap: nowrap;
            align-items: center;
        }
        
        #questionInput {
            flex: 1;
            padding: 15px 25px;
            border: 2px solid var(--neutral-light-gray);
            border-radius: 30px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
            background: var(--neutral-white);
            color: var(--text-dark);
        }
        
        #questionInput::placeholder { color: #99a1ab; }
        #questionInput:focus {
            border-color: var(--main-teal);
            box-shadow: 0 0 0 3px rgba(1, 170, 181, 0.1);
        }

        /* --- Voice Button --- */
        .voice-button {
            width: 50px;
            height: 50px;
            background: var(--neutral-light-gray);
            border: 2px solid var(--neutral-light-gray);
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            color: var(--text-dark);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .voice-button:hover {
            transform: scale(1.05);
            border-color: var(--main-teal);
        }

        .voice-button.listening {
            background: var(--error-red);
            border-color: var(--error-red);
            color: var(--neutral-white);
            animation: voicePulse 1.5s infinite;
        }

        .voice-button.processing {
            background: var(--sub-action-blue);
            border-color: var(--sub-action-blue);
            color: var(--neutral-white);
        }

        @keyframes voicePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* --- Voice Status --- */
        .voice-status {
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-dark);
            color: var(--neutral-white);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .voice-status.show {
            opacity: 1;
        }

        .voice-status::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: var(--text-dark);
        }
        
        #sendButton {
            padding: 0 25px;
            background: var(--main-teal);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(1, 170, 181, 0.2);
            min-width: 80px;
            white-space: nowrap;
            height: 50px;
        }
        
        #sendButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(1, 170, 181, 0.3);
        }
        #sendButton:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* --- Error Message --- */
        .error-message {
            background: var(--error-red);
            color: var(--neutral-white);
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 14px;
            display: none;
        }
        /* --- Responsive Design for Mobile --- */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                border-radius: 16px;
            }

            .input-container {
                flex-direction: row;       /* 버튼들을 가로로 */
                flex-wrap: nowrap;         /* 버튼 줄바꿈 방지 */
                gap: 8px;
                align-items: center;
            }
        
            #questionInput {
                font-size: 14px;
                padding: 12px 16px;
                flex: 1;
            }
        
            #sendButton,
            .voice-button {
                width: auto;
                min-width: 45px;
                height: 42px;
                font-size: 14px;
            }

            .quick-questions {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            }

            .header h1 {
                font-size: 1.8em;
            }

            .header .subtitle {
                font-size: 1em;
            }

            .service-tab {
                font-size: 14px;
                padding: 8px 16px;
            }

            .chat-container {
                max-height: 60vh;
                min-height: 200px;
                height: auto;
            }

            .message {
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 1.4em;
            }

            .header .subtitle {
                font-size: 0.95em;
            }

            .quick-questions {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 10px;
            }

            .quick-question {
                font-size: 13.5px;
                padding: 14px 16px;
            }

            .chat-container {
                max-height: 60vh;
                min-height: 200px;
                height: auto;
            }

            .message {
                font-size: 13.5px;
                padding: 10px 14px;
            }

            #questionInput {
                font-size: 14px;
                padding: 12px 18px;
            }

            #sendButton,
            .voice-button {
                font-size: 14px;
                height: 42px;
            }

            .service-tab {
                font-size: 13px;
                padding: 6px 12px;
            }

            .status-indicator {
                font-size: 12.5px;
                padding: 8px 12px;
            }

            .lang-icon {
                width: 32px;
                height: 32px;
                font-size: 18px;
            }

            .bot-avatar {
                width: 32px;
                height: 32px;
                font-size: 16px;
            }

            .voice-status {
                font-size: 11px;
                top: -30px;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <div class="language-selector">
            <div class="lang-icon" data-lang="ko" onclick="changeLanguage('ko')">
            <img src="flags/kr.png" alt="Korean" width="24">
            </div>
            <div class="lang-icon" data-lang="en" onclick="changeLanguage('en')">
            <img src="flags/us.png" alt="English" width="24">
            </div>
            <div class="lang-icon" data-lang="ja" onclick="changeLanguage('ja')">
            <img src="flags/jp.png" alt="Japanese" width="24">
            </div>
            <div class="lang-icon" data-lang="zh" onclick="changeLanguage('zh')">
            <img src="flags/cn.png" alt="Chinese" width="24">
            </div>
            <div class="lang-icon" data-lang="es" onclick="changeLanguage('es')">
            <img src="flags/es.png" alt="Spanish" width="24">
            </div>
        </div>
        <div class="container">
            <div class="header">
                <h1 data-lang-key="header_title">인천국제공항 AI 챗봇</h1>
                <div class="subtitle" data-lang-key="header_subtitle">주차장 · 시설 · 항공편 정보를 한 번에!</div>
            </div>

            <div class="service-tabs">
                <div class="service-tab" data-category="all" data-lang-key="tab_all">🌟&nbsp;전체 서비스</div>
                <div class="service-tab" data-category="parking" data-lang-key="tab_parking">🚗&nbsp;주차장</div>
                <div class="service-tab" data-category="facility" data-lang-key="tab_facility">🏪&nbsp;시설</div>
                <div class="service-tab" data-category="flight" data-lang-key="tab_flight">✈️&nbsp;항공편</div>
            </div>

            <div class="status-indicator">
                <div class="status-dot"></div>
                <span data-lang-key="status_text">실시간 정보 서비스 운영 중</span>
            </div>

            <div class="error-message" id="errorMessage"></div>
            
            <div class="quick-questions" id="quickQuestions"></div>
            
            <div class="chat-container" id="chatContainer"></div>
            
            <div class="input-container">
                <input type="text" id="questionInput" onkeypress="handleKeyPress(event)">
                <button class="voice-button" id="voiceButton" onclick="toggleVoiceRecognition()">
                    <i class="fas fa-microphone"></i>
                    <div class="voice-status" id="voiceStatus"></div>
                </button>
                <button onclick="sendQuestion()" id="sendButton" data-lang-key="send_button">전송</button>
            </div>
        </div>
    </div>

    <script>
        // Azure Speech SDK 환경변수 설정
        const AZURE_SPEECH_KEY = '';
        const AZURE_SPEECH_REGION = 'koreacentral';
        
        let currentLang = 'ko';
        let speechRecognizer = null;
        let isListening = false;

        const translations = {
            'ko': {
                'header_title': '인천국제공항 AI 챗봇',
                'header_subtitle': '주차장 · 시설 · 항공편 정보를 한 번에!',
                'tab_all': '🌟&nbsp;전체 서비스',
                'tab_parking': '🚗&nbsp;주차장',
                'tab_facility': '🏪&nbsp;시설',
                'tab_flight': '✈️&nbsp;항공편',
                'status_text': '실시간 정보 서비스 운영 중',
                'input_placeholder': '예: 출국장 내 한식당 위치 정보 ',
                'send_button': '전송',
                'voice_listening': '음성 인식 중...',
                'voice_processing': '처리 중...',
                'voice_error': '음성 인식 오류가 발생했습니다.',
                'voice_not_supported': '음성 인식을 지원하지 않습니다.',
                'voice_permission_denied': '마이크 권한이 거부되었습니다.',
                'initial_bot_message': `안녕하세요! 인천국제공항 통합 안내 챗봇입니다. 😊

🔹 주차장 정보 (혼잡도, 잔여 공간)
🔹 공항 시설 안내 (환전소, 식당, 면세점 등)
🔹 항공편 정보 (출발/도착 시간, 게이트, 현지 날씨)
🔹 여행 준비물 및 공항 이용 꿀팁

💬 텍스트 입력 또는 🎤 음성 입력으로 질문해보세요!

💡 항공편 번호를 함께 입력하시면 더 정확한 정보를 알려드릴 수 있어요!`
            },
            'en': {
                'header_title': 'Incheon Airport AI Guide',
                'header_subtitle': 'Parking, Facilities, and Flight Info at once!',
                'tab_all': '🌟&nbsp;All Services',
                'tab_parking': '🚗&nbsp;Parking',
                'tab_facility': '🏪&nbsp;Facilities',
                'tab_flight': '✈️&nbsp;Flights',
                'status_text': 'Real-time information service is running',
                'input_placeholder': 'e.g., Where is the Korean restaurant in the departure lounge? ',
                'send_button': 'Send',
                'voice_listening': 'Listening...',
                'voice_processing': 'Processing...',
                'voice_error': 'Voice recognition error occurred.',
                'voice_not_supported': 'Voice recognition is not supported.',
                'voice_permission_denied': 'Microphone permission denied.',
                'initial_bot_message': `Hello! Welcome to the Incheon Airport AI Guide. 😊

🔹 Parking status (congestion, available spots)  
🔹 Facility info (currency exchange, restaurants, duty-free shops)  
🔹 Flight details (departure/arrival time, gate, weather)  
🔹 Travel tips & preparation checklist  

💬 Ask via text or 🎤 voice input!

💡 For more accurate results, please include your flight number in your question!`
            },
            'ja': {
                'header_title': '仁川国際空港 AI案内',
                'header_subtitle': '駐車場・施設・フライト情報を一度に！',
                'tab_all': '🌟&nbsp;全サービス',
                'tab_parking': '🚗&nbsp;駐車場',
                'tab_facility': '🏪&nbsp;施設',
                'tab_flight': '✈️&nbsp;フライト',
                'status_text': 'リアルタイム情報サービス運営中',
                'input_placeholder': '例: 出国ターミナル内の韓国料理店はどこですか？ ',
                'send_button': '送信',
                'voice_listening': '音声認識中...',
                'voice_processing': '処理中...',
                'voice_error': '音声認識エラーが発生しました。',
                'voice_not_supported': '音声認識がサポートされていません。',
                'voice_permission_denied': 'マイクの権限が拒否されました。',
                'initial_bot_message': `こんにちは！仁川国際空港AI案内チャットボットです。😊

🔹 駐車場情報（混雑度、空きスペース）  
🔹 空港施設の案内（両替所、レストラン、免税店など）  
🔹 フライト情報（出発/到着時間、ゲート、天気）  
🔹 旅行の準備物や空港利用のヒント  

💬 テキスト入力または🎤音声入力で質問してください！

💡 フライト番号を一緒に入力すると、より正確な情報をご案内できますよ！`
            },
            'zh': {
                'header_title': '仁川国际机场 AI指南',
                'header_subtitle': '停车场、设施、航班信息一站式服务！',
                'tab_all': '🌟&nbsp;所有服务',
                'tab_parking': '🚗&nbsp;停车场',
                'tab_facility': '🏪&nbsp;设施',
                'tab_flight': '✈️&nbsp;航班',
                'status_text': '实时信息服务运行中',
                'input_placeholder': '例如：出境大厅里的韩餐厅在哪里？ ',
                'send_button': '发送',
                'voice_listening': '语音识别中...',
                'voice_processing': '处理中...',
                'voice_error': '语音识别出现错误。',
                'voice_not_supported': '不支持语音识别。',
                'voice_permission_denied': '麦克风权限被拒绝。',
                'initial_bot_message': `您好！欢迎使用仁川国际机场AI指南 😊

🔹 停车场信息（拥堵情况、剩余车位）  
🔹 机场设施指南（兑换处、餐厅、免税店等）  
🔹 航班信息（起飞/到达时间、登机口、天气）  
🔹 行前准备及机场小贴士  

💬 通过文字或🎤语音输入提问！

💡 输入航班号可以获得更精准的信息哦！`
            },
            'es': {
                'header_title': 'Guía IA del Aeropuerto de Incheon',
                'header_subtitle': '¡Estacionamiento, Instalaciones e Información de Vuelos!',
                'tab_all': '🌟&nbsp;Todos los Servicios',
                'tab_parking': '🚗&nbsp;Estacionamiento',
                'tab_facility': '🏪&nbsp;Instalaciones',
                'tab_flight': '✈️&nbsp;Vuelos',
                'status_text': 'Servicio de información en tiempo real en funcionamiento',
                'input_placeholder': 'Ej: Dónde está el restaurante coreano en la sala de embarque? ',
                'send_button': 'Enviar',
                'voice_listening': 'Escuchando...',
                'voice_processing': 'Procesando...',
                'voice_error': 'Error de reconocimiento de voz.',
                'voice_not_supported': 'Reconocimiento de voz no soportado.',
                'voice_permission_denied': 'Permiso de micrófono denegado.',
                'initial_bot_message': `¡Hola! Bienvenido a la Guía IA del Aeropuerto de Incheon. 😊

🔹 Información de estacionamiento (congestión, espacios disponibles)  
🔹 Guía de instalaciones (casa de cambio, restaurantes, tiendas duty-free)  
🔹 Información de vuelos (hora de salida/llegada, puerta, clima)  
🔹 Consejos para tu viaje y uso del aeropuerto  

💬 ¡Pregunta por texto o 🎤 entrada de voz!

💡 ¡Incluye tu número de vuelo para obtener información más precisa!`
            }
        };

        const allQuestions = [
            // 전체 서비스 (혼합)
            {
                text: { ko: '주차장 + 주변 시설', en: 'Parking + Nearby Facilities', ja: '駐車場+周辺施設', zh: '停车场+周边设施', es: 'Parking + Instalaciones Cercanas' },
                category: 'mixed', emoji: '🚗',
                question: { ko: 'T1 단기주차장 현재 상황과 운영 중인 주변 식당', en: 'Current situation of T1 short-term parking and nearby restaurants', ja: 'T1短期駐車場の現在の状況と営業中の周辺レストラン', zh: 'T1短期停车场现状及周边营业餐厅', es: 'Situación actual del parking de corta estancia de la T1 y restaurantes cercanos' }
            },
            {
                text: { ko: '항공편 + 날씨', en: 'Flights + Weather', ja: 'フライト+天気', zh: '航班+天气', es: 'Vuelos + Clima' },
                category: 'mixed', emoji: '🌤️',
                question: { ko: '7C1301편 정보와 도착지 날씨 정보', en: '7C1301 flight information and destination weather', ja: '7C1301便の情報と目的地の天気', zh: '7C1301航班信息和目的地天气信息', es: 'Información del vuelo 7C1301 y clima en destino' }
            },

            // 주차장
            {
                text: { ko: 'T1 단기주차장 현재 상황', en: 'T1 Short-term Parking Status', ja: 'T1短期駐車場の現在の状況', zh: 'T1短期停车场现状', es: 'Estado del estacionamiento T1 corto plazo' },
                category: 'parking', emoji: '🚗',
                question: { ko: 'T1 단기주차장 현재 상황', en: 'Current status of T1 short-term parking', ja: 'T1短期駐車場の現在の状況', zh: 'T1短期停车场现状', es: 'Estado actual del estacionamiento T1 corto plazo' }
            },
            {
                text: { ko: '가장 여유로운 주차장', en: 'Most Available Parking Lot', ja: '最も空いている駐車場', zh: '最空闲的停车场', es: 'Estacionamiento más disponible' },
                category: 'parking', emoji: '🚗',
                question: {ko: "T2 장기주차장 잔여 공간", en: "T2 Long-term Parking Lot Availability", ja: "T2長期駐車場空き情報", zh: "T2长期停车场空余车位", es: "¿Espacio disponible en el estacionamiento de larga estancia T2?" }
            },

            // 시설
            {
                text: { ko: '약국 위치와 운영시간', en: 'Pharmacy Info', ja: '薬局の場所と営業時間', zh: '药店位置和营业时间', es: 'Ubicación y horario de farmacias' },
                category: 'facility', emoji: '💊',
                question: { ko: '약국 위치와 운영시간은 어떻게 되나요?', en: 'Where are the pharmacies and what are their hours?', ja: '薬局の場所と営業時間を教えて', zh: '药店在哪？几点开？', es: '¿Dónde están las farmacias y su horario?' }
            },
            {
                text: { ko: '편의점 위치와 운영시간', en: 'Convenience Store Info', ja: 'コンビニの場所と営業時間', zh: '便利店位置和营业时间', es: 'Ubicación y horario de tiendas de conveniencia'},
                category: 'facility', emoji: '🏪',
                question: { ko: 'CU 편의점 위치와 운영시간 알려줘', en: 'Where are the CU convenience stores and what are their hours?', ja: 'コンビニの場所と営業時間を教えて', zh: 'CU便利店在哪？几点开？', es: '¿Dónde están las tiendas de conveniencia y su horario?' }
            },

            // 항공편
            {
                text: { ko: '도착지 날씨', en: 'Destination Weather', ja: '目的地の天気', zh: '目的地天气', es: 'Clima en destino' },
                category: 'flight', emoji: '🌤️',
                question: { ko: '나 지금 타이베이가는데 날씨 어때?', en: 'I m going to Taipei, what the weather like?', ja: '台北に行くんだけど天気は？', zh: '我现在飞往台北，那边天气怎么样？', es: 'Voy a Taipei, ¿cómo está el clima allá?' }
            },
            {
                text: { ko: '오늘 후쿠오카 가는 항공편 정보', en: 'Today\'s Flights to Fukuoka', ja: '今日の福岡行きフライト情報', zh: '今天前往福冈的航班信息', es: 'Vuelos de hoy a Fukuoka' },
                category: 'flight', emoji: '🛫',
                question: { ko: '오늘 후쿠오카 가는 항공편 정보 알려줘', en: 'Can you tell me today\'s flights to Fukuoka?', ja: '今日の福岡行きのフライトを教えて', zh: '告诉我今天飞往福冈的航班信息好吗？', es: '¿Cuáles son los vuelos de hoy a Fukuoka?' }
            }
        ];

        const chatContainer = document.getElementById('chatContainer');
        const questionInput = document.getElementById('questionInput');
        const sendButton = document.getElementById('sendButton');
        const serviceTabs = document.querySelectorAll('.service-tab');
        const quickQuestionsContainer = document.getElementById('quickQuestions');
        const voiceButton = document.getElementById('voiceButton');
        const voiceStatus = document.getElementById('voiceStatus');

        // Azure Speech 음성 인식 초기화
        function initAzureSpeechRecognition() {
            try {
                const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(AZURE_SPEECH_KEY, AZURE_SPEECH_REGION);
                
                // 언어별 설정
                const langCodes = {
                    'ko': 'ko-KR',
                    'en': 'en-US', 
                    'ja': 'ja-JP',
                    'zh': 'zh-CN',
                    'es': 'es-ES'
                };
                
                speechConfig.speechRecognitionLanguage = langCodes[currentLang] || 'ko-KR';
                
                const audioConfig = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
                speechRecognizer = new SpeechSDK.SpeechRecognizer(speechConfig, audioConfig);

                speechRecognizer.recognizing = (s, e) => {
                    console.log('인식 중:', e.result.text);
                    // 실시간 결과 표시 (선택사항)
                    if (e.result.text) {
                        questionInput.value = e.result.text;
                    }
                };

                speechRecognizer.recognized = (s, e) => {
                    if (e.result.reason === SpeechSDK.ResultReason.RecognizedSpeech) {
                        console.log('인식 완료:', e.result.text);
                        questionInput.value = e.result.text;

                        speechRecognizer.stopContinuousRecognitionAsync();
                        // 음성 입력 완료 후 자동으로 질문 전송
                        setTimeout(() => {
                            if (e.result.text.trim()) {
                                sendQuestion();
                            }
                        }, 500);
                    }
                    stopVoiceRecognition();
                };

                speechRecognizer.canceled = (s, e) => {
                    console.log('음성 인식 취소:', e.reason);
                    let errorMessage = translations[currentLang]['voice_error'];
                    
                    if (e.reason === SpeechSDK.CancellationReason.Error) {
                        if (e.errorDetails.includes('PermissionDenied')) {
                            errorMessage = translations[currentLang]['voice_permission_denied'];
                        }
                    }
                    
                    showErrorMessage(errorMessage);
                    stopVoiceRecognition();
                };

                speechRecognizer.sessionStopped = (s, e) => {
                    console.log('음성 인식 세션 중지');
                    stopVoiceRecognition();
                };

            } catch (error) {
                console.error('Azure Speech 초기화 오류:', error);
                showErrorMessage(translations[currentLang]['voice_not_supported']);
            }
        }

        function toggleVoiceRecognition() {
            if (!speechRecognizer) {
                showErrorMessage(translations[currentLang]['voice_not_supported']);
                return;
            }

            if (isListening) {
                speechRecognizer.stopContinuousRecognitionAsync();
                stopVoiceRecognition();
            } else {
                try {
                    isListening = true;
                    voiceButton.classList.add('listening');
                    voiceStatus.textContent = translations[currentLang]['voice_listening'];
                    voiceStatus.classList.add('show');
                    
                    // 기존 인식기가 있으면 먼저 정리
                    if (speechRecognizer) {
                        speechRecognizer.stopContinuousRecognitionAsync();
                    }
                    
                    speechRecognizer.startContinuousRecognitionAsync();
                } catch (error) {
                    console.error('음성 인식 시작 오류:', error);
                    showErrorMessage(translations[currentLang]['voice_error']);
                    stopVoiceRecognition();
                }
            }
        }

        function stopVoiceRecognition() {
            isListening = false;
            voiceButton.classList.remove('listening', 'processing');
            voiceStatus.classList.remove('show');
            voiceStatus.textContent = '';
        }

        function showErrorMessage(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function changeLanguage(lang) {
            currentLang = lang;
            document.documentElement.lang = lang;

            document.querySelectorAll('[data-lang-key]').forEach(element => {
                const key = element.getAttribute('data-lang-key');
                if (translations[lang][key]) {
                    element.innerHTML = translations[lang][key];
                }
            });
            
            questionInput.placeholder = translations[lang]['input_placeholder'] || '';
            
            document.querySelectorAll('.lang-icon').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.lang-icon[data-lang='${lang}']`).classList.add('active');

            // Azure Speech 언어 설정 업데이트
            if (speechRecognizer) {
                speechRecognizer.close();
                initAzureSpeechRecognition();
            }

            localStorage.setItem('airport-lang', lang);
        }

        function renderQuickQuestions(category) {
            quickQuestionsContainer.innerHTML = '';
            const filteredQuestions = category === 'all' 
                ? allQuestions
                : allQuestions.filter(q => q.category === category);

            filteredQuestions.forEach(q => {
                const qDiv = document.createElement('div');
                qDiv.className = `quick-question ${q.category}`;
                qDiv.innerHTML = `<span>${q.emoji}</span> ${q.text[currentLang]}`;
                qDiv.onclick = () => askQuestion(q.question[currentLang]);
                quickQuestionsContainer.appendChild(qDiv);
            });
        }

        serviceTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                serviceTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                renderQuickQuestions(tab.dataset.category);
            });
        });

        function addMessage(content, isUser = false) {
            if (isUser) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message user-message';
                messageDiv.innerHTML = content.replace(/\n/g, '<br>');
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                return messageDiv;
            } else {
                const wrapper = document.createElement('div');
                wrapper.className = 'bot-message-wrapper';
                const avatar = document.createElement('div');
                avatar.className = 'bot-avatar';
                avatar.innerHTML = '<i class="fas fa-plane"></i>';
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message bot-message';
                messageDiv.innerHTML = content.replace(/\n/g, '<br>');
                wrapper.appendChild(avatar);
                wrapper.appendChild(messageDiv);
                chatContainer.appendChild(wrapper);

                wrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
                return wrapper;
            }
        }

        function showTypingIndicator() {
            const indicatorContent = `<div class="typing-indicator"><span></span><span></span><span></span></div>`;
            return addMessage(indicatorContent, false);
        }

        async function sendQuestion() {
            const question = questionInput.value.trim();
            if (!question || questionInput.disabled) return;

            addMessage(question, true);
            questionInput.value = '';
            questionInput.disabled = true;
            sendButton.disabled = true;

            const typingMessageWrapper = showTypingIndicator();

            try {
                const response = await fetch('/api/chatbot_rag', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: question })
                });

                const data = await response.json();
                typingMessageWrapper.remove();

                if (data.status === 'success') {
                    addMessage(data.answer);
                } else {
                    addMessage(`⚠️ 오류: ${data.message}`);
                }

            } catch (error) {
                if (typingMessageWrapper) typingMessageWrapper.remove();
                console.error('API 오류:', error);
                addMessage('😅 죄송합니다. 서버 연결에 문제가 발생했습니다.');
            } finally {
                questionInput.disabled = false;
                sendButton.disabled = false;
                questionInput.focus();
            }
        }

        function askQuestion(question) {
            if (questionInput.disabled) return;
            questionInput.value = question;
            sendQuestion();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') sendQuestion();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const langFromUrl = urlParams.get('lang');
            const savedLang = langFromUrl || localStorage.getItem('airport-lang') || 'ko';
            
            changeLanguage(savedLang);
            addMessage(translations[currentLang].initial_bot_message);
            
            // Azure Speech 음성 인식 초기화
            initAzureSpeechRecognition();

        });
    </script>
</body>
</html>
